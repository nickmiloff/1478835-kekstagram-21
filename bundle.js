(()=>{"use strict";(()=>{const e=(e=0,t=Number.MAX_SAFE_INTEGER)=>{const n=e+Math.random()*(t+1-e);return Math.floor(n)};window.utils={getRandomElem:t=>t[e(0,t.length-1)],getRandomInt:e,isEscButton:e=>"Escape"===e,isEnterButton:e=>"Enter"===e,shuffleArr:e=>{for(let t=e.length-1;t>0;t--){let n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e},debounceDecorator:e=>{let t=null;return function(...n){t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...n)}),500)}},getDeclension:(e,t)=>t[e%100>4&&e%100<20?2:[2,0,1,1,1,2][e%10<5?e%10:5]]}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector("#pictures-error").content.querySelector(".pictures-error"),n=document.querySelector("#error").content.querySelector(".error"),r=document.querySelector("#success").content.querySelector(".success"),o=(t,n)=>{const r=e.appendChild(t),o=()=>{e.removeChild(r),document.removeEventListener("keydown",s)},s=e=>{window.utils.isEscButton(e.key)&&o()};r.querySelector(`.${n}__button`).addEventListener("click",o),document.addEventListener("keydown",s),r.addEventListener("click",(e=>{e.target.closest(`.${n}__inner`)||o()}))};window.errors={loadError:n=>{const r=t.cloneNode(!0);r.querySelector(".pictures-error__title").textContent=n;const o=e.appendChild(r);setTimeout((()=>{e.removeChild(o)}),5e3)},uploadError:e=>{const t=n.cloneNode(!0);o(t,"error")},uploadSuccess:()=>{const e=r.cloneNode(!0);o(e,"success")}}})(),(()=>{const e="https://21.javascript.pages.academy/kekstagram/data",t="https://21.javascript.pages.academy/kekstagram",n={400:"Неверный запрос (400).",401:"Не авторизованный пользователь (401).",402:"Необходима оплата (402).",403:"Запрещено (не уполномочен) (403).",404:"Не найдено (404).",405:"Метод не поддерживается (405).",406:"Неприемлемо (406).",407:"Необходима аутентификация прокси (407).",408:"Истекло время ожидания (408).",409:"Конфликт (409).",410:"Удалён (410).",411:"Необходима длина (411).",412:"Условие ложно (412).",413:"Полезная нагрузка слишком велика (413).",414:"URI слишком длинный (414).",415:"Ееподдерживаемый тип данных (415).",416:"Диапазон не достижим (416).",417:"Ожидание не удалось (417).",418:"Я — чайник (418).",419:"Ошибка проверки CSRF (419).",421:"Неправильный запрос (421).",422:"Необрабатываемый экземпляр (422).",423:"Заблокировано (423).",424:"Невыполненная зависимость (424).",425:"Слишком рано (425).",426:"Необходимо обновление (426).",428:"Необходимо предусловие (428).",429:"Слишком много запросов (429).",431:"Поля заголовка запроса слишком большие (431).",449:"Повторить с (449).",451:"Недоступно по юридическим причинам (451).",499:"Клиент закрыл соединение (499)."},r=(e,t)=>{const r=new XMLHttpRequest;return r.responseType="json",r.addEventListener("load",(()=>{let o;switch(r.status.toString()[0]){case"2":window.picturesArr=r.response,e();break;case"4":o=n[r.status];break;default:o=`${r.statusText} (${r.status}).`}o&&t(o)})),r.addEventListener("error",(()=>{t("Ошибка соединения (001).")})),r.addEventListener("timeout",(()=>{t("Превышено время ожидания ответа от сервера (002).")})),r.timeout=1e5,r};window.backend={load:(t,n)=>{const o=r(t,n);o.open("GET",e),o.send()},upload:(e,n,o)=>{const s=r(n,o);s.open("POST",t),s.send(e)}}})(),(()=>{const e=document.querySelector(".social__comment-count"),t=document.querySelector(".comments-loader"),n=document.querySelector(".social__comments"),r=document.querySelector(".social__comment").cloneNode(!0);let o;class s{constructor(e){this._arr=e,this._length=e.length,this._startCount=0,this._endCount=0,this._stringName=window.utils.getDeclension(this._length,["комментария","комментариев","комментариев"]),this.isMax=!1}get currentString(){return this.isMax?null:`${this._endCount} из <span class="comments-count">${this._length}</span> ${this._stringName}`}get currentSlice(){return this.isMax?null:this._arr.slice(this._startCount,this._endCount)}isLastStep(){return this._endCount===this._length}increaseCount(){if(!this.isMax){const e=this._endCount+5>this._length?this._length:this._endCount+5;this._startCount=this._endCount,this._endCount=e,this._startCount===this._length&&(this.isMax=!0)}return!!this.isMax}}const i=()=>{if(!o.increaseCount()){e.innerHTML=o.currentString;const s=(e=>{const t=document.createDocumentFragment();return e.forEach((e=>{const n=r.cloneNode(!0);n.querySelector(".social__picture").src=e.avatar,n.querySelector(".social__picture").alt=e.name,n.querySelector(".social__text").textContent=e.message,t.appendChild(n)})),t})(o.currentSlice);n.appendChild(s),o.isLastStep()&&t.classList.add("hidden")}};t.addEventListener("click",i),window.comments={set:e=>{o=new s(e),t.classList.remove("hidden"),n.textContent="",i()}}})(),(()=>{const e=document.querySelector(".big-picture"),t=document.querySelector(".big-picture__cancel"),n=e=>{window.utils.isEscButton(e.key)&&r()},r=()=>{document.body.classList.remove("modal-open"),e.classList.add("hidden"),document.removeEventListener("keydown",n)};t.addEventListener("click",r),window.bigPicture={render:t=>{e.querySelector(".big-picture__img").querySelector("img").src=t.url,e.querySelector(".likes-count").textContent=t.likes,e.querySelector(".comments-count").textContent=t.comments.length,e.querySelector(".social__caption").textContent=t.description,window.comments.set(t.comments)},open:()=>{document.body.classList.add("modal-open"),e.classList.remove("hidden"),document.addEventListener("keydown",n)}}})(),(()=>{const e=document.querySelector(".pictures"),t=document.querySelector("#picture").content.querySelector(".picture"),n=document.querySelector(".img-filters");e.addEventListener("click",(t=>{const n=t.target.closest(".picture");if(n){const t=(t=>{const n=e.querySelectorAll(".picture");return Array.from(n).indexOf(t)})(n);window.bigPicture.render(window.picturesArr[t]),window.bigPicture.open()}}));const r=()=>{const n=(e=>{const n=document.createDocumentFragment();return e.forEach((e=>{const r=t.cloneNode(!0);r.querySelector(".picture__img").src=e.url,r.querySelector(".picture__likes").textContent=e.likes,r.querySelector(".picture__comments").textContent=e.comments.length,n.appendChild(r)})),n})(window.picturesArr);(()=>{const t=document.querySelectorAll(".picture");for(const n of t)e.removeChild(n)})(),e.appendChild(n)};window.pictures={init:()=>{r(),window.pictures.defaultPicuresArr=window.picturesArr.slice(),n.classList.remove("img-filters--inactive")},render:r}})(),(()=>{const e=document.querySelector(".img-filters__form"),t={default(){return this.getDefaultArr()},random(){return window.utils.shuffleArr(this.getDefaultArr()).slice(0,10)},discussed(){return this.getDefaultArr().sort(((e,t)=>t.comments.length===e.comments.length?t.likes-e.likes:t.comments.length-e.comments.length))},getDefaultArr:()=>window.pictures.defaultPicuresArr.slice()},n=window.utils.debounceDecorator(((e,n)=>{document.querySelector(".img-filters__button--active").classList.remove("img-filters__button--active"),window.picturesArr=t[n](),window.pictures.render(),e.classList.add("img-filters__button--active")}));e.addEventListener("click",(e=>{if(e.target.classList.contains("img-filters__button")){const t=e.target.id.replace("filter-","");n(e.target,t)}}))})(),(()=>{const e=document.querySelector(".img-upload__effect-level"),t=e.querySelector(".effect-level__line"),n=e.querySelector(".effect-level__value"),r=e.querySelector(".effect-level__pin"),o=e.querySelector(".effect-level__depth");window.slider={node:e,value:n,pin:r,handler:e=>{const s=s=>{let i=(r.offsetLeft+s.movementX)/t.offsetWidth*100;i>100?i=100:i<0&&(i=0),r.style.left=i+"%",o.style.width=i+"%",n.value=Math.floor(i),e(Math.floor(i))},i=()=>{document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",i)},setValue:(e=0)=>{r.style.left=e+"%",o.style.width=e+"%",n.value=e}}})(),(()=>{const e={input:document.querySelector("#upload-file"),modal:document.querySelector(".img-upload__overlay"),img:document.querySelector(".img-upload__preview img"),closeButton:document.querySelector(".img-upload__cancel"),hashtagsInput:document.querySelector(".text__hashtags"),descriptionTextarea:document.querySelector(".text__description"),form:document.querySelector(".img-upload__form")},t=t=>{window.utils.isEscButton(t.key)&&document.activeElement!==e.hashtagsInput&&document.activeElement!==e.descriptionTextarea&&n()},n=()=>{e.form.reset(),document.body.classList.remove("modal-open"),e.modal.classList.add("hidden"),window.slider.setValue(),e.img.removeAttribute("style"),document.removeEventListener("keydown",t)};e.input.addEventListener("change",(()=>{const n=e.input.files[0],r=new FileReader;window.scale.set(),r.addEventListener("loadend",(()=>{e.img.src=r.result,document.body.classList.add("modal-open"),e.modal.classList.remove("hidden"),window.slider.node.classList.add("hidden"),document.addEventListener("keydown",t)})),n&&r.readAsDataURL(n)})),e.closeButton.addEventListener("click",n),window.preview={close:n,img:e.img,form:e.form,hashtagsInput:e.hashtagsInput,descriptionTextarea:e.descriptionTextarea}})(),(()=>{const e=document.querySelector(".effects__list"),t={chrome:{filter:"grayscale",min:0,max:1,measure:""},sepia:{filter:"sepia",min:0,max:1,measure:""},marvin:{filter:"invert",min:0,max:100,measure:"%"},phobos:{filter:"blur",min:0,max:3,measure:"px"},heat:{filter:"brightness",min:1,max:3,measure:""}};let n="none";const r=e=>{if("none"!==n){const r=t[n],o=(r.max-r.min)/100*e+r.min,s=`${r.filter}(${o}${r.measure})`;window.preview.img.style.filter=s}};e.addEventListener("click",(e=>{const t=e.target.classList.contains("effects__radio")?e.target.value:null;t&&((e="none")=>{n=e,window.preview.img.style.removeProperty("filter"),window.slider.setValue(100),r(100);const t="none"!==e?"remove":"add";window.slider.node.classList[t]("hidden")})(t)})),window.slider.pin.addEventListener("mousedown",(()=>{window.slider.handler(r)}))})(),(()=>{const e=document.querySelector(".img-upload__scale"),t={value:e.querySelector(".scale__control--value"),smallerButton:e.querySelector(".scale__control--smaller"),biggerButton:e.querySelector(".scale__control--bigger")},n=(e=100)=>{e-25<25?(t.value.value="25%",window.preview.img.style.transform="scale(0.25)"):e+25>100?(t.value.value="100%",window.preview.img.style.transform="scale(1)"):(t.value.value=e+"%",window.preview.img.style.transform=`scale(${e/100})`)};t.smallerButton.addEventListener("click",(()=>{const e=t.value.value;n(parseInt(e,10)-25)})),t.biggerButton.addEventListener("click",(()=>{const e=t.value.value;n(parseInt(e,10)+25)})),window.scale={set:n}})(),(()=>{const e=e=>{const t=[],n=[{messageTemplate:"Превышено максимальное кол-во хеш-тегов: 5.",testError(){return e.length>5?`${this.messageTemplate} Вы ввели: ${e.length} хэш-тегов.`:null}},{messageTemplate:"Один и тот же хэш-тег не может быть использован дважды.",testError(){const t=new Set(e);return e.length!==t.size?`${this.messageTemplate} Проверьте: "${(e=>{const t=new Set;return e.forEach(((n,r)=>{e.indexOf(n,r+1)>0&&t.add(n)})),Array.from(t).join(", ")})(e)}."`:null}}],r=[{messageTemplate:'Хэш-тег должен начинаться с символа "#".',elements:[],testError(e){"#"!==e[0]&&this.elements.push(e)}},{messageTemplate:"Хэш-тег должен состоять из букв и чисел и не может содержать пробелы, спецсимволы (#, @, $ и т. п.), символы пунктуации (тире, дефис, запятая и т. п.), эмодзи и т. д.",elements:[],testError(e){/^[#a-zа-я0-9][a-zа-я0-9]{0,}$/.test(e)||this.elements.push(e)}},{messageTemplate:"Хеш-тег не может состоять только из одной решётки.",elements:[],testError(e){"#"===e[0]&&1===e.length&&this.elements.push(e)}},{messageTemplate:"Максимальная длина одного хэш-тега 20 символов.",elements:[],testError(e){e.length>20&&this.elements.push(e)}}];if(""===e[0]&&1===e.length)return"";for(const t of n){const n=t.testError(e);if(n)return n}e.forEach((e=>{for(const t of r)t.testError(e)}));for(const e of r)e.elements.length>0&&t.push(`${e.messageTemplate} Ошибка в этих хэш-тегах: "${e.elements.join(", ")}".`);return t.length>0?t.join(" "):""};window.preview.hashtagsInput.addEventListener("input",(()=>{const t=window.preview.hashtagsInput.value.trim().toLowerCase().split(" "),n=e(t);window.preview.hashtagsInput.setCustomValidity(n)}))})(),document.querySelector(".img-upload__submit").addEventListener("click",(e=>{if(window.preview.form.checkValidity()){e.preventDefault();const t=new FormData(window.preview.form);window.preview.close(),window.backend.upload(t,window.errors.uploadSuccess,window.errors.uploadError)}else window.preview.hashtagsInput.classList.add("invalid-input"),setTimeout((()=>{window.preview.hashtagsInput.classList.remove("invalid-input")}),5e3)})),window.backend.load(window.pictures.init,window.errors.loadError),window.slider.setValue()})();